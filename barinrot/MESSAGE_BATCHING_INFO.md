# 📦 מערכת איסוף הודעות (Message Batching)

## 🎯 מה זה?
מערכת חכמה שאוספת מספר הודעות רצופות מאותו משתמש ושולחת אותן ביחד ל-GPT לתשובה אחת מקיפה.

---

## ⚙️ איך זה עובד?

### 1️⃣ **הודעה ראשונה מגיעה:**
- מתחיל טיימר של **10 שניות** ⏱️
- מופעל **Typing indicator** (הלקוח רואה "מקליד...")
- ההודעה נכנסת ל-batch (תור)

### 2️⃣ **הודעות נוספות מגיעות (בתוך 10 שניות):**
- כל הודעה חדשה **מאפסת את הטיימר** ל-10 שניות מחדש 🔄
- ההודעה מתוספת ל-batch
- ה-Typing indicator ממשיך לרוץ

### 3️⃣ **הטיימר נגמר (אין עוד הודעות):**
- כל ההודעות מאוחדות להודעה אחת (מופרדות ב-`\n`)
- ההודעה המאוחדת נשלחת ל-GPT
- GPT עונה **פעם אחת** על כל ההודעות
- התשובה נשלחת בווטסאפ **ללא quote** (לא "הגב")

---

## 📝 דוגמאות

### דוגמה 1: 3 הודעות רצופות
```
לקוח: "היי" (0 שניות)
       🕐 טיימר מתחיל (10 שניות)
       ⌨️ Typing...

לקוח: "אני בן 25" (3 שניות)
       🔄 טיימר מתאפס (10 שניות מחדש)
       ⌨️ Typing...

לקוח: "רוצה להתאמן" (5 שניות)
       🔄 טיימר מתאפס (10 שניות מחדש)
       ⌨️ Typing...

--- 10 שניות עוברות ---

GPT מקבל: "היי\nאני בן 25\nרוצה להתאמן"
GPT עונה: "היי! נעים להכיר. בן 25 זה גיל מעולה להתחיל..."
```

### דוגמה 2: הודעה אחת בלבד
```
לקוח: "מה המחיר?" (0 שניות)
       🕐 טיימר מתחיל (10 שניות)
       ⌨️ Typing...

--- 10 שניות עוברות ---

GPT מקבל: "מה המחיר?"
GPT עונה: "אימון ניסיון עולה 10 ש"ח לילדים..."
```

---

## 💾 שמירה למאגר

ההודעות המאוחדות נשמרות ב-`conversations` table כ-**שורה אחת**:

```sql
INSERT INTO conversations (client_phone, message_role, message_content)
VALUES ('972555555555', 'user', 'היי\nאני בן 25\nרוצה להתאמן');
```

**יתרון:** חיסכון בטוקנים ובמקום במאגר!

---

## 🔧 הגדרות

```javascript
const BATCH_DELAY = 10000; // 10 שניות (10,000 מילישניות)
```

**איפה לשנות:** שורה 1065 ב-`server.js`

רוצה 5 שניות? שנה ל-`5000`  
רוצה 15 שניות? שנה ל-`15000`

---

## ⌨️ Typing Indicator

הבוט מפעיל **Typing indicator** בזמן ההמתנה כדי שהלקוח ידע שהוא מקשיב.

- מתחדש כל **5 שניות** (כי ווטסאפ מבטל אותו אוטומטית)
- נעצר כשהטיימר מסתיים

---

## 📤 שליחת תשובה

**לפני:** `message.reply(response)` - יוצר quote (הגב)  
**עכשיו:** `whatsappClient.sendMessage(sessionId, response)` - הודעה רגילה ✅

---

## 🛠️ פונקציות חדשות

1. **`addMessageToBatch(message, sessionId, chat)`**
   - מוסיפה הודעה ל-batch
   - מפעילה/מאפסת טיימר
   - מפעילה typing indicator

2. **`processBatchedMessages(sessionId, messages, chat)`**
   - מאחדת הודעות
   - שולחת ל-GPT
   - שולחת תשובה

---

## ✅ יתרונות

- 🎯 GPT רואה את התמונה המלאה
- 💰 חיסכון בקריאות API (פחות כסף)
- 🧠 תשובות מקיפות יותר
- ⚡ חוויה טובה יותר למשתמש
- 💾 חיסכון בטוקנים ובמאגר

---

## ⚠️ הערות

- אם לקוח שולח הודעה **אחת בלבד** - הוא עדיין יחכה 10 שניות
- אין הגבלה על כמות הודעות - הטיימר פשוט ממשיך להתאפס
- ההודעות נשמרות **ביחד** במאגר (אופציה ב' שבחרת)

---

## 🚀 מוכן לשימוש!

המערכת פעילה ועובדת! פשוט שלח הודעות רצופות והבוט יאסוף אותן. 🎉



