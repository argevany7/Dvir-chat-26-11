# מערכת פולואו אפ אוטומטית - מדריך מלא

## סקירה כללית

מערכת פולואו אפ אוטומטית חכמה ששולחת הודעות ללקוחות שלא השלימו רכישה, עם התאמה אישית מלאה לכל לקוח.

---

## 🎯 תכונות עיקריות

### 1. **התחלה אוטומטית**
- המערכת מזהה אוטומטית כשלקוח לא ענה במשך 24 שעות
- מפעילה פולואו אפ רק ללקוחות שלא שילמו
- לא מציקה ללקוחות שכבר שילמו או חסומים

### 2. **6 שלבי הודעות**

#### הודעה 1 (יום אחרי הודעה אחרונה)
- הודעה יצירתית ומגוונת
- דוגמאות: "היי [שם]! 😊 עדיין מעוניין באימונים?"

#### הודעה 2 (יום אחרי הודעה 1)
- שליחת GIF מהקובץ `followUp.gif`
- ללא טקסט, רק הקובץ

#### הודעה 3 (יום אחרי הודעה 2)
- הודעה יצירתית דומה להודעה 1

#### הודעה 4 (יומיים אחרי הודעה 3) - **הודעה אישית**
- מנתחת את סיכום השיחה
- מזהה נקודות כאב (ביטחון עצמי, לחץ, אנרגיות, בריונות)
- מתאימה את ההודעה למצב הספציפי של הלקוח
- אם אין סיכום - שולחת הודעה גנרית

דוגמה:
```
היי דני! 😊

אני זוכר שסיפרת שמתמודד עם חוסר ביטחון עצמי. דרך אומנויות הלחימה דביר עוזר לבנות ביטחון עצמי וכוח פנימי.

זו באמת הזדמנות לשנות דברים מקצה לקצה 💪
```

#### הודעה 5 (יומיים אחרי הודעה 4)
- שאלה קצרה: "איך זה נשמע לך? זה משהו שלדעתך יכול לעזור?"

#### הודעה 6+ (כל שלושה ימים)
- הודעה קבועה: "היי זה אריאל, עדיין מעוניין באימונים? 🥊"
- ממשיכה לנצח כל 3 ימים (עד שהלקוח מגיב או מבקש להפסיק)

### 3. **זיהוי חכם של תגובות**

#### תגובה חיובית
כשהלקוח עונה: "כן", "בטח", "מעוניין", וכו'
- **המערכת:**
  - עוצרת את הפולואו אפ
  - שולחת הודעת קבלת פנים חמה
  - מזכירה פרטים מהשיחה הקודמת
  - ממשיכה שיחה רגילה עם הבוט

דוגמה:
```
דני! 😊 שמח מאוד שחזרת אלינו!

הכל בסדר לגמרי, אין צורך להתנצל 🙏

אני זוכר שדיברנו על הניסיון שלך בקראטה. נשמח להתקדם איתך!
זוכר שהיית מעוניין באיגרוף תאילנדי. זה עדיין רלוונטי? 🥊
```

#### תגובה שלילית
כשהלקוח אומר: "די", "לא מעוניין", "תפסיק", וכו'
- **שלב ראשון - שאלת "למה?":**
  - המערכת שולחת שאלה מנומסת
  - מזכירה פרטים אישיים
  - מנסה להבין מה השתנה

דוגמה:
```
דני, אני מבין 😊

אשמח לדעת מה השתנה? אולי אוכל לעזור או להציע משהו אחר שיתאים לך יותר
```

- **שלב שני - אם הלקוח עונה:**
  - הבוט מנסה לשכנע בעדינות
  - **אך לא ממשיך להציק בפולואו אפ**
  - הפולואו אפ נעצר סופית

- **שלב שני - אם הלקוח לא עונה:**
  - הפולואו אפ נעצר אוטומטית
  - לא שולח עוד הודעות

#### תגובה רגילה
כשהלקוח עונה משהו אחר
- המערכת מאפסת את הפולואו אפ
- ממשיכה שיחה רגילה עם הבוט
- אם הלקוח שוב לא עונה במשך 24 שעות - הפולואו אפ מתחיל מחדש

### 4. **רנדומליות טבעית**
- שעת שליחה: בין 8:00-20:00 (אקראית)
- רנדומליות קטנה בזמנים (±2 שעות)
- הודעות מגוונות (6 וריאציות שונות להודעות 1 ו-3)

---

## 📊 שדות במסד הנתונים

הושפו לטבלת `clients`:
- `followup_enabled` - האם פולואו אפ מופעל
- `followup_attempts` - מספר ניסיונות שנשלחו
- `last_followup_date` - תאריך הודעת פולואו אפ אחרונה
- `next_followup_date` - מתי לשלוח את ההודעה הבאה
- `followup_stopped` - האם הלקוח ביקש להפסיק
- `last_message_date` - תאריך הודעה אחרונה מהלקוח
- `awaiting_stop_response` - האם ממתינים לתשובה על "למה?"

---

## 🔧 API Endpoints

### 1. בדיקת סטטוס לקוח
```bash
GET /api/followup-status/:phone
```

דוגמה:
```bash
curl http://localhost:3001/api/followup-status/0501234567
```

תגובה:
```json
{
  "success": true,
  "client": {
    "phone": "972501234567",
    "name": "דני",
    "followupEnabled": true,
    "followupAttempts": 3,
    "followupStopped": false,
    "lastFollowupDate": "2025-10-27T10:30:00.000Z",
    "nextFollowupDate": "2025-10-28T14:45:00.000Z",
    "paymentConfirmed": false,
    "lastMessageDate": "2025-10-26T18:20:00.000Z",
    "status": "פעיל"
  }
}
```

### 2. שליחת פולואו אפ ידנית (לבדיקות)
```bash
POST /api/test-followup
Content-Type: application/json

{
  "phone": "0501234567"
}
```

דוגמה:
```bash
curl -X POST http://localhost:3001/api/test-followup \
  -H "Content-Type: application/json" \
  -d '{"phone": "0501234567"}'
```

### 3. בדיקה מיידית של כל הלקוחות
```bash
POST /api/check-followups
```

מפעילה בדיקה מיידית של כל הלקוחות שזקוקים לפולואו אפ (במקום לחכות 30 דקות).

דוגמה:
```bash
curl -X POST http://localhost:3001/api/check-followups
```

### 4. רשימת כל הלקוחות בפולואו אפ
```bash
GET /api/followup-list
```

דוגמה:
```bash
curl http://localhost:3001/api/followup-list
```

תגובה:
```json
{
  "success": true,
  "count": 5,
  "clients": [
    {
      "phone": "972501234567",
      "name": "דני",
      "attempts": 3,
      "lastDate": "2025-10-27T10:30:00.000Z",
      "nextDate": "2025-10-28T14:45:00.000Z",
      "status": "פעיל",
      "enabled": true
    }
  ]
}
```

---

## ⚙️ איך המערכת עובדת?

### זרימת העבודה:

1. **לקוח שולח הודעה**
   - `last_message_date` מתעדכן

2. **24 שעות עוברות ללא תגובה**
   - המערכת מפעילה פולואו אפ
   - מחשבת מתי לשלוח את ההודעה הראשונה (בשעה אקראית)

3. **טיימר אוטומטי (כל 30 דקות)**
   - בודק אם יש לקוחות עם `next_followup_date` שהגיע
   - שולח להם הודעה
   - מחשב מתי לשלוח את ההודעה הבאה

4. **לקוח מגיב**
   - המערכת מזהה את סוג התגובה (חיובית/שלילית/רגילה)
   - מטפלת בהתאם

5. **לקוח משלם**
   - `payment_confirmed` משתנה ל-TRUE
   - הפולואו אפ נעצר אוטומטית

---

## 🚀 הפעלה

המערכת מופעלת אוטומטית כשהשרת עולה.

לוגים שתראה:
```
✅ חיבור למאגר מידע הושלם בהצלחה
✅ טבלאות נוצרו בהצלחה
✅ נוספה עמודה followup_enabled ל-clients
✅ נוספה עמודה followup_attempts ל-clients
...
🔔 מפעיל מערכת פולואו אפ אוטומטית...
✅ מערכת פולואו אפ פועלת - בדיקה כל 30 דקות
```

---

## 📝 לוגים

המערכת מדפיסה לוגים מפורטים:

### בדיקת פולואו אפ:
```
🔍 בדיקת פולואו אפ מתוזמנת...
🔔 נמצאו 3 לקוחות לפולואו אפ
📤 שולח פולואו אפ ללקוח: דני (ניסיון 3)
📤 הודעת פולואו אפ נשלחה: היי דני! 😊 עדיין מעוניין באימונים?...
✅ פולואו אפ עודכן - ניסיון 3, הבא ב-28/10/2025, 14:45:00
```

### תגובות לקוח:
```
🔔 לקוח נמצא בפולואו אפ - מנתח תגובה...
✅ לקוח הגיב באופן חיובי לפולואו אפ
✅ לקוח חזר! עוצר פולואו אפ ומתחיל שיחה רגילה
```

```
🔔 לקוח נמצא בפולואו אפ - מנתח תגובה...
✋ לקוח ביקש להפסיק - נשלחה שאלת "למה?"
```

---

## 🛠️ פתרון תקלות

### הפולואו אפ לא מתחיל
1. בדוק ש-`last_message_date` מתעדכן כשלקוח שולח הודעה
2. ודא ש-`payment_confirmed = FALSE`
3. בדוק ש-`followup_stopped = FALSE`
4. ודא שעברו 24 שעות מההודעה האחרונה

### הודעות לא נשלחות
1. בדוק שהבוט מחובר ל-WhatsApp
2. ודא שהטיימר רץ (צריך לראות לוגים כל 30 דקות)
3. בדוק ש-`next_followup_date` קטן מהזמן הנוכחי
4. השתמש ב-`POST /api/check-followups` לבדיקה מיידית

### GIF לא נשלח
1. ודא שקובץ `followUp.gif` קיים בתיקיית הפרויקט
2. בדוק הרשאות קריאה לקובץ
3. ראה לוגים אם יש שגיאה בשליחה

---

## 💡 טיפים

### בדיקה מהירה
במקום לחכות 24 שעות, תוכל לעדכן ידנית את `last_message_date`:
```sql
UPDATE clients 
SET last_message_date = datetime('now', '-25 hours') 
WHERE phone = '972501234567';
```

ואז להריץ:
```bash
curl -X POST http://localhost:3001/api/check-followups
```

### מעקב אחר לקוח
```bash
# בדיקת סטטוס
curl http://localhost:3001/api/followup-status/0501234567

# שליחת הודעה מיידית (לבדיקה)
curl -X POST http://localhost:3001/api/test-followup \
  -H "Content-Type: application/json" \
  -d '{"phone": "0501234567"}'
```

### צפייה בכל הלקוחות בפולואו אפ
```bash
curl http://localhost:3001/api/followup-list | jq
```

---

## ⚠️ הערות חשובות

1. **לקוחות חסומים**: המערכת לא שולחת פולואו אפ ללקוחות ב-`blocked_contacts`

2. **לקוחות ששילמו**: המערכת לא שולחת פולואו אפ ללקוחות עם `payment_confirmed = TRUE`

3. **כיבוד בקשות**: כשלקוח מבקש להפסיק - המערכת מכבדת את זה ולא ממשיכה להציק

4. **זכירת פרטים**: המערכת משתמשת בסיכום השיחה (`chat_summaries`) כדי ליצור הודעות אישיות

5. **טיימר**: הטיימר רץ רק אחרי ש-WhatsApp מחובר (אירוע `ready`)

---

## 📞 תמיכה

אם יש בעיות או שאלות, בדוק:
1. את הלוגים בקונסול
2. את ה-endpoints לניטור
3. את מסד הנתונים ישירות

---

**המערכת מוכנה לשימוש! 🚀**



