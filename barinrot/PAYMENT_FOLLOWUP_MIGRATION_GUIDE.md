# מערכת מעבר לפולואו-אפ רגיל ללקוחות שלא שילמו 💰

## סקירה כללית

מערכת חכמה שמעבירה אוטומטית לקוחות שקיבלו קישור תשלום אבל לא השלימו אותו, לפולואו-אפ רגיל עם הודעה ראשונה מותאמת אישית ב-GPT.

---

## 🎯 הזרימה המלאה

### **שלב 1: קישור תשלום + תזכורת ראשונה**
```
קישור תשלום נשלח → payment_link_sent_date
    ↓
שם מלא התקבל → full_name_received = TRUE, waiting_for_payment = TRUE
    ↓
⏰ 5 שעות
    ↓
תזכורת: "[שם]! מחכה לעדכון ששילמת 😊"
    ↓
payment_reminder_sent = TRUE, payment_reminder_date = NOW
```

### **שלב 2: מעבר לפולואו-אפ (24 שעות אחרי תזכורת)**
```
⏰ 24 שעות מתזכורת
    ↓
אם לא שילם:
  1️⃣ שליחת התראה למנהלים (דביר + אריאל)
  2️⃣ יצירת הודעה ראשונה עם GPT (זיהוי אם מועד עבר)
  3️⃣ שליחת הודעה ללקוח
  4️⃣ עדכון DB:
     - waiting_for_payment = FALSE
     - followup_enabled = TRUE
     - followup_attempts = 1 (כבר נשלחה הודעה 1!)
     - next_followup_date = +24 שעות (להודעה 2)
```

### **שלב 3: פולואו-אפ רגיל מהודעה 2**
```
⏰ 24 שעות → הודעה 2: GIF (followUp.gif)
    ↓
⏰ 24 שעות → הודעה 3: הודעה יצירתית
    ↓
⏰ 48 שעות → הודעה 4: GPT מותאם אישית 🎯
    ↓
⏰ 48 שעות → הודעה 5: שאלה
    ↓
⏰ כל 3 ימים → הודעה 6+: "עדיין מעוניין באימונים?"
```

---

## 🤖 הודעה ראשונה מותאמת אישית (GPT-4o-mini)

### **מה GPT מקבל:**
- שם הלקוח
- גיל
- תאריך ושעת אימון שנקבעו
- סוג אימון (MMA / אגרוף תאילנדי)
- התאריך והשעה הנוכחיים
- סיכום השיחה המקורית

### **מה GPT עושה:**

#### **אם מועד האימון עבר:**
```
היי רועי! 😊
ראיתי שקיבלת קישור לתשלום לאימון ביום שני אבל לא השלמת את התהליך.
המועד עבר אבל לא נורא בכלל! אנחנו יכולים לקבוע לך אימון חדש בקלות.

אגב, אתה בחרת אגרוף תאילנדי - אם אתה רוצה לנסות משהו יותר שלם 
יש לנו גם MMA (אגרופים, בעיטות וגם קרקע). רק רעיון 💪

עדיין מעוניין?
```

**תכונות:**
- ✅ מזהה שהמועד עבר
- ✅ מציע לקבוע אימון חדש
- ✅ מציע גם את הסוג השני:
  - בחר תאילנדי → מציע MMA
  - בחר MMA → מציע תאילנדי

#### **אם מועד האימון עוד לא עבר:**
```
היי רועי! 😊
ראיתי שקיבלת קישור לתשלום לאימון ביום שני בשעה 20:15 אבל לא השלמת את התהליך.
המקום עדיין שמור בשבילך!

אם משהו לא ברור או שיש בעיה עם התשלום - אשמח לעזור.
עדיין מעוניין? 🥊
```

**תכונות:**
- ✅ מזכיר את התאריך והשעה המדויקים
- ✅ מדגיש שהמקום עדיין שמור
- ✅ מציע עזרה במקרה של בעיה

### **Fallback:**
במקרה של שגיאה ב-GPT - הודעה גנרית:
```
[שם]! ראיתי שקיבלת קישור לתשלום אבל לא השלמת את התהליך. 
עדיין מעוניין באימונים? 🥊
```

---

## 📢 התראה למנהלים

כשלקוח עובר לפולואו-אפ, המנהלים מקבלים הודעה:

```
💰 לקוח לא השלים תשלום - עבר לפולואו-אפ רגיל

שם: רועי כהן
גיל: 28
סוג אימון: MMA

📅 תאריך אימון שנקבע: 15/11/2024
🕐 שעה: 20:15

📞 טלפון: 0501234567

⏱️ קו זמנים:
- קישור תשלום נשלח: 10/11/2024, 18:30
- תזכורת נשלחה: 10/11/2024, 23:45
- עבר לפולואו-אפ: 12/11/2024, 00:00

סיכום השיחה:
רועי מעוניין ב-MMA לפרוק עצבים מהעבודה. 
יש לו ניסיון קודם בג'ודו. נקבע אימון ליום שני אבל לא שילם.

הלקוח עבר כעת לפולואו-אפ רגיל עם הודעה ראשונה מותאמת אישית.

---
נשלח ע"י אריאל - מערכת ניהול לידים 🤖
```

**נשלח ל:**
- דביר: `972508422092@c.us`
- אריאל: `972559925657@c.us`

---

## 🔧 פונקציות חדשות

### 1. `generatePersonalizedPaymentFollowupMessage(client)`
**מיקום:** שורה 2181-2280

**מה היא עושה:**
- טוענת היסטוריית שיחה
- חולצת פרטי לקוח (שם, גיל, תאריך אימון, סוג)
- שולחת ל-GPT-4o-mini פרומפט מפורט
- מקבלת הודעה מותאמת אישית
- זיהוי אוטומטי: האם מועד עבר או עדיין פתוח

**פרמטרים:**
- `client` - אובייקט לקוח מהמאגר

**מחזירה:**
- הודעה מותאמת אישית (string)
- או fallback גנרי במקרה של שגיאה

---

### 2. `migrateUnpaidToRegularFollowup()`
**מיקום:** שורה 2286-2357

**מה היא עושה:**
- בודקת לקוחות 24 שעות אחרי תזכורת תשלום
- מסננת: לא שילמו, לא חסומים, עדיין לא בפולואו-אפ
- לכל לקוח:
  1. שולחת התראה למנהלים
  2. יוצרת הודעה ראשונה עם GPT
  3. שולחת ללקוח
  4. מעבירה לפולואו-אפ רגיל (`followup_attempts = 1`)

**קריאה:** רצה אוטומטית כל 30 דקות (טיימר)

---

### 3. `sendUnpaidClientNotificationToManagers(client)`
**מיקום:** שורה 2363-2413

**מה היא עושה:**
- חולצת פרטי לקוח מהשיחה
- בונה הודעת התראה מפורטת
- שולחת לדביר ואריאל

**פרמטרים:**
- `client` - אובייקט לקוח מהמאגר

---

## ⏱️ טיימרים

### **טיימר קיים (תזכורת תשלום):**
```javascript
// רץ כל 30 דקות
setInterval(checkPaymentReminders, 30 * 60 * 1000);
```
- בודק לקוחות 5 שעות אחרי שם מלא
- שולח: "[שם]! מחכה לעדכון ששילמת 😊"

### **טיימר חדש (מעבר לפולואו-אפ):**
```javascript
// רץ כל 30 דקות
setInterval(migrateUnpaidToRegularFollowup, 30 * 60 * 1000);
```
- בודק לקוחות 24 שעות אחרי תזכורת
- מעביר לפולואו-אפ רגיל עם הודעה אישית

---

## 💾 שינויים במסד הנתונים

### **לא נדרשים שינויים!**

כל השדות כבר קיימים:
- ✅ `payment_link_sent_date`
- ✅ `payment_reminder_sent`
- ✅ `payment_reminder_date`
- ✅ `waiting_for_payment`
- ✅ `followup_enabled`
- ✅ `followup_attempts`
- ✅ `next_followup_date`

---

## 🧪 דוגמת זרימה מלאה

### **יום ראשון, 18:00**
```sql
-- לקוח מקבל קישור תשלום
UPDATE clients SET payment_link_sent_date = '2024-11-10 18:00:00' WHERE phone = '0501234567';
```

### **יום ראשון, 19:00**
```sql
-- לקוח נותן שם מלא
UPDATE clients SET 
  full_name = 'רועי כהן',
  full_name_received = TRUE,
  full_name_received_date = '2024-11-10 19:00:00',
  waiting_for_payment = TRUE
WHERE phone = '0501234567';
```

### **יום שני, 00:00 (5 שעות אחרי)**
```
✅ טיימר checkPaymentReminders רץ
📤 שולח תזכורת: "רועי! מחכה לעדכון ששילמת 😊"
```
```sql
UPDATE clients SET 
  payment_reminder_sent = TRUE,
  payment_reminder_date = '2024-11-11 00:00:00'
WHERE phone = '0501234567';
```

### **יום שלישי, 00:30 (24 שעות אחרי תזכורת)**
```
✅ טיימר migrateUnpaidToRegularFollowup רץ
🎨 יוצר הודעה אישית עם GPT
📢 שולח התראה למנהלים
📤 שולח ללקוח: "היי רועי! ראיתי שקיבלת קישור לתשלום..."
```
```sql
UPDATE clients SET 
  waiting_for_payment = FALSE,
  followup_enabled = TRUE,
  followup_attempts = 1,
  last_followup_date = '2024-11-12 00:30:00',
  next_followup_date = '2024-11-13 00:30:00',  -- +24 שעות
  last_message_date = '2024-11-12 00:30:00'
WHERE phone = '0501234567';
```

### **יום רביעי, 00:30 (24 שעות אחרי הודעה 1)**
```
✅ טיימר checkFollowupSchedule רץ
📤 שולח הודעה 2: GIF (followUp.gif)
```
```sql
UPDATE clients SET 
  followup_attempts = 2,
  next_followup_date = '2024-11-14 00:30:00'  -- +24 שעות
WHERE phone = '0501234567';
```

### **יום חמישי, 00:30 (24 שעות אחרי הודעה 2)**
```
✅ טיימר checkFollowupSchedule רץ
📤 שולח הודעה 3: "היי רועי! זה אריאל שוב 😊 חשבת על האימונים?"
```

### **יום שבת, 14:00 (48 שעות אחרי הודעה 3)**
```
✅ טיימר checkFollowupSchedule רץ
🎯 שולח הודעה 4: GPT מותאם אישית לפי סיכום השיחה
```

**וכן הלאה...**

---

## 📊 סטטיסטיקות

### **עלויות GPT:**
- **הודעה ראשונה מותאמת**: ~$0.02 (GPT-4o-mini)
- **סיכום השיחה** (אם לא קיים): ~$0.03 (GPT-4o-mini)
- **סה"כ ללקוח**: ~$0.05

### **זמנים:**
- תזכורת תשלום: 5 שעות
- מעבר לפולואו-אפ: 24 שעות (סה"כ ~29 שעות מקישור)
- הודעה 2 (GIF): +24 שעות
- הודעה 3: +24 שעות
- הודעה 4 (GPT אישי): +48 שעות
- הודעה 5: +48 שעות
- הודעה 6+: כל 3 ימים

---

## ✅ יתרונות המערכת

1. ✅ **אוטומציה מלאה** - אין צורך בהתערבות ידנית
2. ✅ **הודעה מותאמת אישית** - GPT מזהה מועדים ומציע פתרונות
3. ✅ **הצעת סוג אימון נוסף** - מגדיל סיכוי להמרה
4. ✅ **התראות למנהלים** - שקיפות מלאה
5. ✅ **שימוש חוזר בפולואו-אפ קיים** - אין צורך בקוד חדש
6. ✅ **6 שלבי פולואו-אפ** - GIF, הודעות יצירתיות, GPT אישי
7. ✅ **לא "נופל בין הכיסאות"** - כל לקוח מקבל טיפול

---

## 🚀 הפעלה

המערכת כבר פועלת! 

לוגים שתראה:
```
⏰ Payment reminders timer activated (30 min intervals)
⏰ Unpaid clients migration timer activated (30 min intervals)

...

🔍 Checking payment reminders...
⏰ Found 2 clients awaiting payment reminder
📤 Payment reminder sent to 972501234567

...

🔍 Checking unpaid clients migration to regular followup...
🔄 נמצאו 1 לקוחות שלא שילמו - מעביר לפולואו-אפ רגיל
🎨 יוצר הודעת פולואו-אפ מותאמת אישית ללקוח 972501234567...
✅ הודעה מותאמת אישית נוצרה בהצלחה
📤 הודעת פולואו-אפ ראשונה נשלחה ל-972501234567
✅ התראת לקוח שלא שילם נשלחה למנהלים
✅ 972501234567 - הועבר לפולואו-אפ רגיל (ניסיון 1 נשלח)
```

---

**המערכת מוכנה ופועלת! 🎉**



