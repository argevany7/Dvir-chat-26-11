# 📛 מערכת חסימה גמישה - הוראות שימוש

## 🎯 סקירה כללית

מערכת החסימה החדשה מאפשרת חסימה נפרדת של לקוחות מ:
- **בוט רגיל** - הבוט לא יגיב להודעות מהלקוח
- **פולואו אפ** - הלקוח לא יקבל הודעות פולואו אפ אוטומטיות
- **שניהם** - חסימה מלאה

## 🔐 הרשאות

**רק מנהלים** יכולים להשתמש במערכת החסימה!
- דביר (972526330535)
- אריאל (972545274570)

---

## 📛 חסימת לקוח - פקודת `/block`

### שלב 1: הזנת מספר טלפון
```
/block 0501234567
```

הבוט יבקש ממך להזין את שם הלקוח:
```
מספר הטלפון: 972501234567

מה שם איש הקשר? 👤

(פשוט כתוב את השם המלא)

💡 /cancel לביטול
```

### שלב 2: הזנת שם
הזן את השם המלא של הלקוח, למשל:
```
יוסי כהן
```

### שלב 3: בחירת סוג חסימה
הבוט יציג לך תפריט:

```
📛 חסימת לקוח
──────────────────────────────

👤 שם: יוסי כהן
📞 מספר: 972501234567

בחר סוג חסימה:

1️⃣ - חסימה מבוט רגיל בלבד
   (הבוט לא יגיב להודעות, אך פולואו אפ ימשיך)

2️⃣ - חסימה מפולואו אפ בלבד
   (ללא פולואו אפ, אך הבוט יגיב להודעות)

3️⃣ - חסימה מלאה (בוט + פולואו אפ)

4️⃣ - חזרה לתפריט ראשי

הקלד 1, 2, 3 או 4
💡 או /cancel לביטול
```

### אופציות החסימה:

#### 1️⃣ חסימה מבוט בלבד
- הבוט **לא יגיב** להודעות מהלקוח
- פולואו אפ **ימשיך** לשלוח הודעות
- שימושי כאשר הלקוח מעצבן אך עדיין רלוונטי לפולואו אפ

#### 2️⃣ חסימה מפולואו אפ בלבד  
- פולואו אפ **לא ישלח** הודעות
- הבוט **ימשיך לענות** להודעות מהלקוח
- שימושי כאשר הלקוח לא רוצה פולואו אפ אבל רוצה לשאול שאלות

#### 3️⃣ חסימה מלאה
- הבוט **לא יגיב** להודעות
- פולואו אפ **לא ישלח** הודעות
- חסימה מוחלטת

#### 4️⃣ חזרה לתפריט ראשי
- ביטול התהליך וחזרה לתפריט הראשי

---

## 🔓 הסרת חסימה - פקודת `/unblock`

### דרך 1: דרך תפריט
```
/unblock
```

התפריט:
```
🔓 הסרת חסימה
──────────────────────────────

בחר אופציה:

1️⃣ - הזן מספר טלפון
2️⃣ - הזן מספר סידורי (מתוצאות חיפוש)
3️⃣ - חזור לתפריט ראשי

הקלד 1, 2 או 3
💡 או /cancel לביטול
```

#### אופציה 1: הזן מספר טלפון
הזן את המספר והבוט יחפש אותו:
```
0501234567
```

#### אופציה 2: הזן מספר סידורי
אם השתמשת ב-`/check` לפני כן והיו תוצאות, תוכל להזין את המספר הסידורי:
```
5
```

### דרך 2: הסרה מהירה
אם יש לך תוצאות חיפוש קודמות:
```
/unblock 5
```

### שלב סופי: בחירת מה להסיר

לאחר שבחרת לקוח, הבוט יציג:

```
🔓 הסרת חסימה
──────────────────────────────

👤 שם: יוסי כהן
📞 מספר: 972501234567
📊 סטטוס: חסום מבוט וגם מפולואו אפ

בחר מה להסיר:

1️⃣ - הסר חסימה מבוט רגיל
   (הבוט יחזור לענות להודעות)

2️⃣ - הסר חסימה מפולואו אפ
   (יחזרו הודעות פולואו אפ)

3️⃣ - הסר את כל החסימות

4️⃣ - חזרה לתפריט ראשי

הקלד את מספר האופציה
💡 או /cancel לביטול
```

### אופציות הסרת החסימה:

#### 1️⃣ הסר חסימה מבוט
- הבוט **יחזור לענות** להודעות
- פולואו אפ **יישאר חסום** (אם היה חסום)

#### 2️⃣ הסר חסימה מפולואו אפ
- פולואו אפ **יחזור לשלוח** הודעות
- הבוט **יישאר חסום** (אם היה חסום)

#### 3️⃣ הסר את כל החסימות
- הסרה מוחלטת של כל החסימות
- הבוט יגיב והפולואו אפ ישלח הודעות

#### 4️⃣ חזרה לתפריט ראשי
- ביטול והחזרה לתפריט

---

## 🔍 חיפוש אנשי קשר חסומים - `/check`

פקודה זו מאפשרת לך לחפש ולראות לקוחות חסומים:

```
/check
```

תפריט החיפוש:
```
📋 ניהול אנשי קשר חסומים
סה"כ: 15 אנשי קשר חסומים
──────────────────────────────

בחר אופציה:

1️⃣ - חיפוש לפי מספר טלפון
2️⃣ - חיפוש לפי שם / אות ראשונה

הקלד 1 או 2
💡 או /cancel לביטול
```

### תוצאות החיפוש יראו כך:

```
✅ נמצאו 3 אנשי קשר:
──────────────────────────────

1️⃣ יוסי כהן
   📞 972501234567
   🚫 חסום מבוט וגם מפולואו אפ
   📅 15/11/2025

2️⃣ דנה לוי  
   📞 972523456789
   🚫 חסום מבוט בלבד
   📅 14/11/2025

3️⃣ רועי ישראל
   📞 972541234567
   🚫 חסום מפולואו אפ בלבד
   📅 13/11/2025

💡 להסרת חסימה: /unblock [מספר סידורי]
💡 חזרה לתפריט: /check
```

---

## 🔄 חזרה לתפריט ראשי

בכל שלב תוכל:
- **לבטל** את התהליך: `/cancel`
- **לחזור לתפריט**: `/check`
- **לקבל עזרה**: `/help`

---

## 📝 דוגמאות לשימוש

### דוגמה 1: חסימת לקוח מפולואו אפ בלבד

```
מנהל: /block 0501234567
בוט: מה שם איש הקשר? 👤
מנהל: משה כהן
בוט: [תפריט סוג חסימה]
מנהל: 2
בוט: ✅ המספר נחסם מפולואו אפ!
```

### דוגמה 2: הסרת חסימה מבוט

```
מנהל: /check
בוט: [תפריט חיפוש]
מנהל: 1
בוט: הזן מספר טלפון
מנהל: 0501234567
בוט: [מציג תוצאה עם תפריט הסרת חסימה]
מנהל: 1
בוט: ✅ החסימה מבוט הוסרה בהצלחה!
```

### דוגמה 3: חסימה מלאה

```
מנהל: /block 0527777777
בוט: מה שם איש הקשר? 👤
מנהל: לקוח מעצבן
בוט: [תפריט סוג חסימה]
מנהל: 3
בוט: ✅ המספר נחסם באופן מלא!
```

---

## ⚠️ הערות חשובות

1. **רק מנהלים** יכולים להשתמש בפקודות אלו
2. בכל שלב ניתן לבטל עם `/cancel`
3. חסימה מפולואו אפ **לא תמנע** מהבוט לענות להודעות
4. חסימה מבוט **לא תמנע** משליחת פולואו אפ
5. ניתן **לשנות** את סוג החסימה בכל עת על ידי חסימה מחדש
6. הסרת חסימה חלקית **לא תמחק** את הרשומה - רק תעדכן אותה
7. אם מסירים את **כל החסימות** - הרשומה **נמחקת** מהמערכת

---

## 🆘 פקודות עזרה

- `/block [מספר]` - חסימת לקוח
- `/unblock` - תפריט הסרת חסימה
- `/unblock [מספר]` - הסרת חסימה מהירה
- `/check` - חיפוש אנשי קשר חסומים
- `/cancel` - ביטול תהליך
- `/help` - עזרה

---

## 🔧 מה קורה מאחורי הקלעים?

### בחסימה:
1. המערכת מוסיפה רשומה לטבלת `blocked_contacts`
2. שדות `blocked_from_bot` ו-`blocked_from_followup` מעודכנים לפי הבחירה
3. הבדיקות בקוד מתייחסות לשדות אלו בנפרד

### בפולואו אפ:
```sql
WHERE phone NOT IN (
  SELECT phone FROM blocked_contacts 
  WHERE blocked_from_followup = 1
)
```

### במענה רגיל:
```javascript
const isBlocked = await isContactBlocked(phone, 'bot');
if (isBlocked) {
    // לא מגיבים
    return;
}
```

---

**נוצר ב-15/11/2025**  
**גרסה: 1.0**





