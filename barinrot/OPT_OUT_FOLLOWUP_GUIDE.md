# מערכת הפסקת הודעות פולואו אפ (Opt-Out Followup Only)

## 📋 סקירה כללית

מערכת חכמה שמזהה כאשר לקוח מבקש להפסיק לקבל הודעות פולואו אפ, אבל **לא** אומר שהוא לא מעוניין לחלוטין באימונים.

### ההבדל בין "לא מעוניין" ל"הפסיקו לשלוח הודעות"

- **"לא מעוניין"** = הלקוח לא רוצה את השירות → חסימה מלאה
- **"הפסיקו לשלוח הודעות"** = הלקוח לא רוצה הודעות אוטומטיות → הפסקת פולואו אפ בלבד

---

## 🎯 איך זה עובד?

### שלב 1: זיהוי הבקשה

המערכת משתמשת ב-GPT-4o-mini כדי לזהות בקשות להפסקת הודעות פולואו אפ:

**דוגמאות שמזוהות:**
- "תפסיק לשלוח לי הודעות"
- "אל תשלח לי עוד הודעות"
- "די עם ההודעות"
- "תפסיקו לשלוח פולואו אפ"
- "אני לא רוצה לקבל יותר הודעות"
- "תסיר אותי מהרשימה"
- "הפסיקו לשלוח לי"

**דוגמאות שלא מזוהות (אלה "לא מעוניין"):**
- "לא מעוניין"
- "לא רוצה אימונים"
- "זה לא בשבילי"
- "תודה לא"

### שלב 2: עדכון מסד הנתונים

```sql
UPDATE clients SET 
    opt_out_followup_only = TRUE,
    followup_enabled = FALSE,
    followup_stopped = FALSE,
    early_rejection_followup_enabled = FALSE,
    awaiting_stop_response = FALSE,
    updated_at = CURRENT_TIMESTAMP
WHERE phone = ?
```

### שלב 3: שליחת הודעת התנצלות

המערכת שולחת הודעה אוטומטית:

```
[שם], אני מבין לגמרי ומתנצל 🙏

הסרתי אותך מהודעות הפולואו אפ - לא תקבל יותר הודעות ממני.

אם בעתיד תרצה לחזור אלינו או שיהיו לך שאלות - אנחנו כאן ותמיד נשמח לעזור 😊
```

---

## 🔄 ההבדלים בין opt_out_followup_only לבין followup_stopped

| תכונה | `opt_out_followup_only = TRUE` | `followup_stopped = TRUE` |
|--------|------------------------------|--------------------------|
| **פולואו אפ אוטומטי** | ❌ לא נשלח | ❌ לא נשלח |
| **תגובה להודעות של הלקוח** | ✅ כן, הבוט ימשיך להגיב | ❌ לא, הלקוח נחסם |
| **סטטוס הלקוח** | לקוח שלא רוצה פולואו אפ | לקוח שנחסם לחלוטין |
| **רשום ב-blocked_contacts** | ❌ לא | ✅ כן |

---

## 📊 הלוגיקה בקוד

### קבצים שעודכנו:

1. **`server.js`**
   - הוספת שדה `opt_out_followup_only` למיגרציות (שורה 118)
   - פונקציה `detectOptOutFollowupRequest()` - זיהוי בקשות (שורה 4361)
   - פונקציה `handleOptOutFollowupOnly()` - טיפול בבקשה (שורה 4510)
   - עדכון `processMessage()` - בדיקה לפני כל פולואו אפ (שורות 5293, 5412)
   - עדכון כל קוואריי הפולואו אפ לדלג על לקוחות עם `opt_out_followup_only = TRUE`

2. **`ariel_system_prompt.json`**
   - הוספת סעיף `opt_out_followup_only` להסבר על הכלל החדש (שורה 519)

---

## 🚀 הרצה והטמעה

### אופציה 1: הפעלה מחדש של השרת

כאשר השרת מופעל מחדש, המיגרציות יתבצעו אוטומטית והשדה יתווסף.

```bash
npm start
```

### אופציה 2: הרצת סקריפט מיגרציה ידנית

אם אתה רוצה להוסיף את השדה מבלי להפעיל את השרת מחדש:

```bash
node add_opt_out_followup_field.js
```

---

## 🧪 בדיקות

### תרחיש בדיקה 1: בקשה להפסקת הודעות בפולואו אפ רגיל

1. לקוח מקבל הודעת פולואו אפ
2. לקוח עונה: "תפסיק לשלוח לי הודעות"
3. ✅ המערכת מזהה את הבקשה
4. ✅ המערכת מסירה מפולואו אפ
5. ✅ המערכת שולחת הודעת התנצלות
6. ✅ הבוט ימשיך להגיב אם הלקוח ישלח הודעה חדשה

### תרחיש בדיקה 2: בקשה להפסקת הודעות בפולואו אפ שבועי

1. לקוח מקבל הודעת פולואו אפ שבועי (early rejection)
2. לקוח עונה: "די עם ההודעות"
3. ✅ המערכת מזהה את הבקשה
4. ✅ המערכת מסירה מפולואו אפ שבועי
5. ✅ המערכת שולחת הודעת התנצלות
6. ✅ הבוט ימשיך להגיב אם הלקוח ישלח הודעה חדשה

### תרחיש בדיקה 3: "לא מעוניין" לא מתבלבל עם "הפסקת הודעות"

1. לקוח מקבל הודעת פולואו אפ
2. לקוח עונה: "לא מעוניין"
3. ✅ המערכת מזהה שזה "לא מעוניין" (לא opt-out followup)
4. ✅ המערכת שואלת "למה?"
5. ✅ אם ממשיך להגיד "לא מעוניין" - חוסם לחלוטין

---

## 📝 לוגים

כאשר לקוח מבקש להפסיק פולואו אפ, תראה בלוגים:

```
🤖 GPT מנתח בקשת הפסקת פולואו אפ: "תפסיק לשלוח לי" → תשובה: YES → isOptOut = true
📵 לקוח מבקש להפסיק לקבל הודעות פולואו אפ - מסיר מהפולואו אפ אבל ממשיך להגיב
✅ רועי הוסר מפולואו אפ אבל הבוט ימשיך להגיב
✅ הודעת התנצלות נשלחה ללקוח
```

---

## 🎓 שאלות ותשובות

### מה קורה אם לקוח אומר "לא רוצה" בלי הקשר?

המערכת תבדוק האם זה "לא רוצה אימונים" (לא מעוניין) או "לא רוצה הודעות" (opt-out followup).

### האם אפשר לשחזר לקוח שביקש opt-out?

כן! אם הלקוח ישלח הודעה חדשה והבוט יגיב, הוא יכול לבקש להתחיל מחדש.

### האם ההודעה האוטומטית משתנה לפי הלקוח?

כן, אם יש שם - ההודעה מתחילה עם השם. אם אין - היא מתחילה ישירות עם "אני מבין לגמרי".

### האם זה עובד גם עם פולואו אפ שבועי (early rejection)?

כן! הלוגיקה זהה לפולואו אפ רגיל ולפולואו אפ שבועי.

---

## 🔧 תחזוקה

### שאילתות שימושיות

**בדיקת לקוחות שביקשו opt-out:**
```sql
SELECT phone, name, opt_out_followup_only, followup_stopped 
FROM clients 
WHERE opt_out_followup_only = TRUE;
```

**איפוס opt-out ללקוח ספציפי:**
```sql
UPDATE clients 
SET opt_out_followup_only = FALSE 
WHERE phone = '972XXXXXXXXX';
```

**כמה לקוחות ביקשו opt-out:**
```sql
SELECT COUNT(*) as total_opt_outs 
FROM clients 
WHERE opt_out_followup_only = TRUE;
```

---

## 📞 תמיכה

אם יש בעיות או שאלות:
1. בדוק את הלוגים - חפש "opt_out" או "📵"
2. בדוק שהמיגרציה רצה (השדה קיים בטבלה)
3. בדוק ש-GPT-4o-mini עובד תקין

---

✅ **סיום המסמך**

