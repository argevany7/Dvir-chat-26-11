# מערכת אישור שעת אימון אוטומטית

## תיאור הבעיה
לפני השינוי, במקרים בהם הסוכן לא הצליח לחלץ את שעת האימון מהשיחה, הוא היה שולח הודעת אישור תשלום **ללא שעה קבועה**. זה יצר מצב בעייתי שבו לקוחות רשמו תשלום אבל לא ידעו באיזו שעה להגיע.

## הפתרון
המערכת החדשה משתמשת בגיל של הלקוח כדי להציע שעה אוטומטית מתאימה לפי קבוצת הגיל שלו, ושואלת את הלקוח לאישור לפני סיום השיחה.

---

## תהליך העבודה החדש

### 1. לאחר אישור תשלום
כאשר הלקוח מאשר תשלום, המערכת מנסה לחלץ את השעה מהשיחה:

**אם השעה נמצאה בהיסטוריה:**
- ✅ שולח הודעת אישור עם השעה
- 🏁 מסמן את השיחה כהסתיימה

**אם השעה לא נמצאה:**
- 🔍 בודק אם יש גיל ללקוח
- 💡 מציע שעה אוטומטית לפי קבוצת הגיל
- 📩 שולח הודעה ששואלת אישור
- ⏳ ממתין לתשובת הלקוח

### 2. הצעת שעה לפי גיל

המערכת משתמשת בפונקציה `getSuggestedTimeByAge()` שמציעה שעה לפי קבוצות הגיל:

**MMA (שני וחמישי):**
- גיל 4-6: `17:00`
- גיל 6-9: `17:45`
- גיל 9-12: `18:30`
- גיל 12-16: `19:15`
- גיל 16+: `20:15`

**אגרוף תאילנדי (שלישי):**
- גיל 12-16: `18:30`
- גיל 16+: `19:30`

### 3. הודעת אישור שעה

הלקוח מקבל הודעה כמו:

```
מעולה! קיבלתי את אישור התשלום 🎉

רק רציתי לוודא - מדובר על אימון ב15/11/2025 בשעה 17:45.

תאשר לי שאוכל לרשום אותך לשעה הזו?
```

### 4. טיפול בתשובת הלקוח

**אם הלקוח מאשר (כן/בסדר/אוקיי/מתאים):**
- ✅ השעה נשמרת ב-DB
- 📩 נשלחת הודעת אישור סופית עם הפרטים המלאים
- 🏁 השיחה מסומנת כהסתיימה

**אם הלקוח לא מאשר או שואל שאלה:**
- 🤖 ה-GPT ממשיך לטפל בשיחה
- 💬 יכול לשאול שאלות הבהרה או להציע שעה חלופית

---

## רכיבים טכניים

### פונקציות חדשות

#### 1. `getSuggestedTimeByAge(age, trainingType)`
מחזירה שעת התחלה מתאימה לפי גיל וסוג אימון.

```javascript
const suggestedTime = getSuggestedTimeByAge(8, 'MMA'); // -> "17:45"
```

#### 2. `detectTimeConfirmationWithGPT(message)`
בודקת עם GPT-4o-mini אם הודעת הלקוח מאשרת את השעה.

```javascript
const isConfirmed = await detectTimeConfirmationWithGPT("כן, מתאים"); // -> true
```

### שדות חדשים במאגר הנתונים

טבלת `clients` קיבלה שני שדות נוספים:

1. **`waiting_for_time_confirmation`** (INTEGER)
   - `0` = לא ממתין
   - `1` = ממתין לאישור שעה
   
2. **`suggested_time`** (TEXT)
   - השעה שהוצעה ללקוח (למשל "17:45")
   - `NULL` כשאין שעה מוצעת

### מיגרציה

כדי להוסיף את השדות למאגר קיים, הרץ:

```bash
node add_time_confirmation_fields.js
```

השדות מתווספים גם אוטומטית במערך ה-migrations ב-`server.js`.

---

## דוגמאות לתרחישים

### תרחיש 1: השעה נמצאה בהיסטוריה
```
לקוח: "שילמתי!"
בוט: "מעולה! קיבלתי את אישור התשלום 🎉
      המקום שלך שמור לאימון ב15/11/2025 בשעה 17:45.
      דביר קיבל את הפרטים שלך ומחכה לראות אותך באימון!
      📍 כתובת: הרצוג 12, הרצליה"
[השיחה מסתיימת]
```

### תרחיש 2: השעה לא נמצאה - מציע שעה
```
לקוח: "שילמתי!"
בוט: "מעולה! קיבלתי את אישור התשלום 🎉
      רק רציתי לוודא - מדובר על אימון ב15/11/2025 בשעה 17:45.
      תאשר לי שאוכל לרשום אותך לשעה הזו?"

לקוח: "כן, מתאים"
בוט: "מעולה! המקום שלך שמור לאימון ב15/11/2025 בשעה 17:45.
      דביר קיבל את הפרטים שלך ומחכה לראות אותך באימון!
      📍 כתובת: הרצוג 12, הרצליה"
[השיחה מסתיימת]
```

### תרחיש 3: הלקוח רוצה שעה אחרת
```
לקוח: "שילמתי!"
בוט: "מעולה! קיבלתי את אישור התשלום 🎉
      רק רציתי לוודא - מדובר על אימון ב15/11/2025 בשעה 17:45.
      תאשר לי שאוכל לרשום אותך לשעה הזו?"

לקוח: "לא מתאים, יש אפשרות לשעה 18:30?"
בוט: [GPT ממשיך לטפל] "בוודאי! 18:30 זו הקבוצה של גילאי 9-12.
      אוקיי, אז אני רושם אותך ל15/11/2025 בשעה 18:30?"
```

---

## לוג וניפוי שגיאות

המערכת מדפיסה לוגים מפורטים:

```
⚠️ התראה: השעה לא נקבעה - מנסה לחלץ מההיסטוריה
⚠️ לא הצלחתי לחלץ שעה מההיסטוריה - מנסה להציע שעה לפי גיל...
💡 מציע שעה לפי גיל 8: 17:45
✅ שעה מוצעת עודכנה ב-DB
⏳ ממתין לאישור שעה מהלקוח...
```

כאשר הלקוח עונה:
```
⏰ לקוח ממתין לאישור שעה - בודק את התשובה...
🤖 GPT בודק אם הלקוח אישר את השעה...
✅ הלקוח אישר את השעה!
✅ השעה 17:45 עודכנה ב-DB
🏁 אישור שעה התקבל - מסמן את השיחה כהסתיימה
```

---

## יתרונות הפתרון

✅ **אין יותר אימונים ללא שעה קבועה**
✅ **שעות מתאימות אוטומטית לגיל**
✅ **שקיפות מלאה מול הלקוח**
✅ **אפשרות לתיקון אם הלקוח רוצה שעה אחרת**
✅ **חווית משתמש טובה יותר**

---

## קבצים שהשתנו

1. **`server.js`**
   - הוספת פונקציה `getSuggestedTimeByAge()`
   - הוספת פונקציה `detectTimeConfirmationWithGPT()`
   - שינוי לוגיקת טיפול בתשלום (שורות 5769-5820)
   - הוספת לוגיקת טיפול באישור שעה (שורות 5711-5782)
   - הוספת שדות למערך migrations (שורות 119-121)

2. **`add_time_confirmation_fields.js`** (חדש)
   - סקריפט להוספת שדות למאגר קיים

3. **`TIME_CONFIRMATION_SYSTEM.md`** (חדש)
   - מסמך תיעוד זה

---

## תחזוקה עתידית

אם משנים את שעות האימונים או קבוצות הגיל, יש לעדכן את הפונקציה `getAgeGroup()` שנמצאת בשורה 3206 ב-`server.js`.

---

תאריך עדכון: 15/11/2025
גרסה: 1.0

